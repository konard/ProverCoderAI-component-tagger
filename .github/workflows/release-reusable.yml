name: Release (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref/sha to checkout"
        required: true
        type: string
      branch:
        description: "Branch to push back version bump commit"
        required: false
        type: string
        default: "main"

      package_json_path:
        description: "Path to package.json of the published package"
        required: false
        type: string
        default: "packages/app/package.json"

      pnpm_filter:
        description: "pnpm --filter target (workspace package selector)"
        required: false
        type: string
        default: "./packages/app"

      bump_type:
        description: "changeset bump type: patch/minor/major"
        required: false
        type: string
        default: "patch"

      tag_prefix:
        description: "Tag prefix"
        required: false
        type: string
        default: "v"

      node_version:
        required: false
        type: string
        default: "24"

      copy_readme:
        required: false
        type: boolean
        default: true
      readme_source:
        required: false
        type: string
        default: "README.md"
      readme_dest:
        required: false
        type: string
        default: "packages/app/README.md"

      publish_npm:
        required: false
        type: boolean
        default: true
      publish_github_packages:
        required: false
        type: boolean
        default: true

permissions: {}

concurrency:
  group: release-${{ inputs.ref }}

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      id-token: write
      pull-requests: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: pnpm

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Auto changeset (patch if no changeset exists)
        id: auto_changeset
        if: github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p .changeset

          if ls .changeset/*.md >/dev/null 2>&1; then
            echo "has_changeset=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PKG_NAME="$(node -p "require('./${{ inputs.package_json_path }}').name")"
          CHANGESET_FILE=".changeset/auto-${{ github.sha }}.md"

          printf '%s\n' \
            '---' \
            "\"${PKG_NAME}\": ${{ inputs.bump_type }}" \
            '---' \
            '' \
            'chore: automated version bump' \
            > "$CHANGESET_FILE"

          echo "has_changeset=true" >> "$GITHUB_OUTPUT"

      - name: Version packages
        if: steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          pnpm changeset version

      - name: Read version
        id: release_version
        if: steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./${{ inputs.package_json_path }}').version")"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit version changes
        if: steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore(release): version packages"
          BRANCH="${{ inputs.branch }}"
          git fetch origin "${BRANCH}"
          git rebase "origin/${BRANCH}"
          if ! git push origin "HEAD:${BRANCH}"; then
            git fetch origin "${BRANCH}"
            git rebase "origin/${BRANCH}"
            git push origin "HEAD:${BRANCH}"
          fi

      - name: Tag release
        if: steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.release_version.outputs.version }}"
          TAG="${{ inputs.tag_prefix }}${VERSION}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists"
            exit 0
          fi

          git tag -a "$TAG" -m "$TAG"
          git push origin "$TAG"

      - name: Prepare package README
        if: inputs.copy_readme == true
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "${{ inputs.readme_dest }}")"
          cp "${{ inputs.readme_source }}" "${{ inputs.readme_dest }}"

      - name: Build dist
        if: inputs.publish_npm == true || inputs.publish_github_packages == true
        shell: bash
        run: |
          set -euo pipefail
          pnpm --filter "${{ inputs.pnpm_filter }}" build

      - name: Configure npm auth
        if: inputs.publish_npm == true && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "NPM_TOKEN is not set"
            exit 1
          fi
          printf '%s\n' "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > "$HOME/.npmrc"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: inputs.publish_npm == true
        shell: bash
        run: |
          set -euo pipefail
          PKG_PATH="${{ inputs.package_json_path }}"
          PKG_DIR="$(dirname "$PKG_PATH")"
          DIST_DIR="${PKG_DIR}/dist"
          PKG_NAME="$(node -p "require('./${PKG_PATH}').name")"
          VERSION="$(node -p "require('./${PKG_PATH}').version")"

          if npm view "${PKG_NAME}@${VERSION}" version >/dev/null 2>&1; then
            echo "Version ${VERSION} already published; skipping npm publish."
            exit 0
          fi

          pnpm dlx @prover-coder-ai/dist-deps-prune release \
            --dist "${DIST_DIR}" \
            --package "${PKG_PATH}" \
            --prune-dev true \
            --command "pnpm changeset publish" \
            --silent
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to GitHub Packages
        if: inputs.publish_github_packages == true && steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        shell: bash
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          OWNER_LOWER="$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')"

          PKG_NAME="$(node -p "require('./${{ inputs.package_json_path }}').name")"
          PKG_SUFFIX="${PKG_NAME#*/}"
          if [ "$PKG_SUFFIX" = "$PKG_NAME" ]; then
            GH_PKG="@${OWNER_LOWER}/${PKG_NAME}"
          else
            GH_PKG="@${OWNER_LOWER}/${PKG_SUFFIX}"
          fi

          printf '%s\n' "@${OWNER_LOWER}:registry=https://npm.pkg.github.com" >> "$HOME/.npmrc"
          printf '%s\n' "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> "$HOME/.npmrc"

          node -e "const fs=require('fs');const p='${{ inputs.package_json_path }}';const pkg=require('./'+p);pkg.name='${GH_PKG}';fs.writeFileSync(p, JSON.stringify(pkg, null, 2)+'\n');"
          pnpm --filter "${{ inputs.pnpm_filter }}" publish --registry https://npm.pkg.github.com --no-git-checks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.auto_changeset.outputs.has_changeset == 'true' && github.actor != 'github-actions[bot]'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag_prefix }}${{ steps.release_version.outputs.version }}
          generate_release_notes: true
